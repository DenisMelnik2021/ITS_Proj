{% extends 'incidents/base.html' %}
{% load static %}

{% block title %}Аналитика — инциденты по типам{% endblock %}

{% block content %}
<style>
  .analytics-header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:24px;border-radius:14px;margin-bottom:18px}
  .analytics-header h1{margin:0 0 6px;font-size:20px}
  .analytics-header .small{opacity:.9}
  .metrics{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-top:12px}
  .stats-card{background:rgba(255,255,255,.12);backdrop-filter:blur(2px);border-radius:12px;padding:14px;text-align:center}
  .stats-card .num{font-size:28px;font-weight:800;color:#fff}
  .stats-card .lbl{opacity:.95;margin-top:6px}

  .card{background:#fff;border-radius:14px;box-shadow:0 8px 20px rgba(0,0,0,.06);padding:16px}
  .title{margin:0 0 12px;font-size:16px}
  .chart-box{position:relative;height:360px}
  #noData{display:none;color:#6b7280;padding:8px 2px}
  @media (max-width:640px){
    .chart-box{height:300px}
    .metrics{grid-template-columns:1fr}
  }
</style>

<div class="analytics-header">
  <h1>Аналитика: инциденты по типам</h1>
  <div class="small">Обновлено: <span id="updatedAt"></span></div>
  <div class="metrics">
    <div class="stats-card">
      <div class="num">{{ total_incidents|default:0 }}</div>
      <div class="lbl">Всего инцидентов</div>
    </div>
    <div class="stats-card">
      <div class="num">{{ total_stations|default:0 }}</div>
      <div class="lbl">Станций</div>
    </div>
    <div class="stats-card">
      <div class="num">{{ total_escalators|default:0 }}</div>
      <div class="lbl">Эскалаторов</div>
    </div>
  </div>
</div>

<div class="card">
  <h2 class="title">Круговая диаграмма</h2>
  <div class="chart-box">
    <canvas id="pie"></canvas>
  </div>
  <div id="noData">Нет данных для отображения</div>
</div>

<!-- Chart.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"
        integrity="sha512-ElRFoGQ7sG2zZ0C3Cw4m+2S0l0Qm7G9lVuP+gk8F3t7i6m6yTqv7Xc3o6kZq1m2cGx5XwR8tI8vH3rV3GvTQ8w=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
  document.getElementById('updatedAt').textContent = new Date().toLocaleString();

  const labels = {{ chart_labels|safe|default:"[]" }};
  const values = {{ chart_data|safe|default:"[]" }};

  const el = document.getElementById('pie');
  const noData = document.getElementById('noData');

  if (!labels.length || !values.length) {
    el.style.display = 'none';
    noData.style.display = 'block';
  } else {
    const colors = [
      '#FF6384','#36A2EB','#FFCE56','#4BC0C0',
      '#9966FF','#FF9F40','#FF6B6B','#4ECDC4',
      '#45B7D1','#96CEB4','#FFEAA7','#DDA0DD'
    ].slice(0, labels.length);

    new Chart(el.getContext('2d'), {
      type: 'doughnut',
      data: {
        labels: labels,
        datasets: [{
          data: values,
          backgroundColor: colors,
          borderColor: '#fff',
          borderWidth: 2,
          hoverOffset: 10
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '50%',
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              padding: 14,
              font: { size: 12 },
              generateLabels: (chart) => {
                const ds = chart.data.datasets[0];
                const total = ds.data.reduce((s,v)=>s+v,0) || 0;
                return chart.data.labels.map((l,i)=>({
                  text: `${l}: ${ds.data[i]} (${total?((ds.data[i]/total)*100).toFixed(1):'0.0'}%)`,
                  fillStyle: ds.backgroundColor[i],
                  strokeStyle: '#fff',
                  lineWidth: 2,
                  index: i
                }));
              }
            }
          },
          tooltip: {
            callbacks: {
              label: (ctx) => {
                const total = ctx.dataset.data.reduce((s,v)=>s+v,0) || 0;
                const pct = total ? ((ctx.parsed/total)*100).toFixed(1) : '0.0';
                return `${ctx.label}: ${ctx.parsed} (${pct}%)`;
              }
            }
          }
        },
        animation: { duration: 900, easing: 'easeOutCubic' }
      }
    });
  }
</script>
{% endblock %}
